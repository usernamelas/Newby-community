name: ðŸŽ± Pool Assistant Build

on:
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Build type'
        required: true
        default: 'debug'
        type: choice
        options:
        - debug
        - beta
        - release
      
      flavor:
        description: 'App flavor'
        required: true
        default: 'standard'
        type: choice
        options:
        - standard
        - pro

  push:
    branches: 
      - 'termux-builds'
      - 'release/*'
    tags:
      - 'v*'

  pull_request:
    branches: [ main, develop ]

env:
  JAVA_VERSION: '17'
  ANDROID_API_LEVEL: '34'
  ANDROID_BUILD_TOOLS: '34.0.0'

jobs:
  build:
    name: ðŸ—ï¸ Build APK
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Set up JDK ${{ env.JAVA_VERSION }}
      uses: actions/setup-java@v4
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'temurin'
    
    - name: Setup Android SDK
      uses: android-actions/setup-android@v3
      with:
        api-level: ${{ env.ANDROID_API_LEVEL }}
        build-tools: ${{ env.ANDROID_BUILD_TOOLS }}
    
    - name: Cache Gradle dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*') }}
    
    - name: Make gradlew executable
      run: chmod +x gradlew
    
    - name: Determine build configuration
      id: config
      run: |
        BUILD_TYPE="debug"
        FLAVOR="standard"
        
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          BUILD_TYPE="${{ github.event.inputs.build_type }}"
          FLAVOR="${{ github.event.inputs.flavor }}"
        elif [[ "${{ github.ref }}" == refs/tags/v* ]]; then
          BUILD_TYPE="release"
          FLAVOR="pro"
        elif [[ "${{ github.ref }}" == refs/heads/release/* ]]; then
          BUILD_TYPE="beta"
          FLAVOR="pro"
        fi
        
        echo "build_type=$BUILD_TYPE" >> $GITHUB_OUTPUT
        echo "flavor=$FLAVOR" >> $GITHUB_OUTPUT
        
        echo "ðŸ—ï¸  Build Configuration:"
        echo "   Flavor: $FLAVOR"
        echo "   Build Type: $BUILD_TYPE"
    
    # REMOVED: Setup keystore step - building unsigned
    # - name: Setup keystore
    #   if: steps.config.outputs.build_type == 'release'
    #   ...
    
    - name: Setup keystore
      if: steps.config.outputs.build_type == 'release'
      run: |
        echo "âš ï¸  Skipping custom keystore setup due to potential corruption"
        echo "âœ… Will use debug keystore for all builds"
        
        # Don't setup any release keystore - let it fallback to debug
        echo "# Custom keystore disabled" >> gradle.properties

    - name: Build APK
      run: |
        BUILD_TYPE="${{ steps.config.outputs.build_type }}"
        FLAVOR="${{ steps.config.outputs.flavor }}"
        
        # Capitalize for Gradle task
        FLAVOR_CAP="$(tr '[:lower:]' '[:upper:]' <<< ${FLAVOR:0:1})${FLAVOR:1}"
        BUILD_TYPE_CAP="$(tr '[:lower:]' '[:upper:]' <<< ${BUILD_TYPE:0:1})${BUILD_TYPE:1}"
        
        echo "ðŸ—ï¸ Building $FLAVOR_CAP $BUILD_TYPE_CAP APK..."
        
        # Always use debug for now to avoid keystore issues
        if [ "$BUILD_TYPE" = "release" ]; then
          echo "ðŸ“± Building release APK with debug keystore (safer)"
          ./gradlew assemble${FLAVOR_CAP}Debug --stacktrace
        else
          ./gradlew assemble${FLAVOR_CAP}${BUILD_TYPE_CAP} --stacktrace
        fi

    - name: Build unsigned APK
      run: |
        BUILD_TYPE="${{ steps.config.outputs.build_type }}"
        FLAVOR="${{ steps.config.outputs.flavor }}"
        
        # Capitalize for Gradle task
        FLAVOR_CAP="$(tr '[:lower:]' '[:upper:]' <<< ${FLAVOR:0:1})${FLAVOR:1}"
        BUILD_TYPE_CAP="$(tr '[:lower:]' '[:upper:]' <<< ${BUILD_TYPE:0:1})${BUILD_TYPE:1}"
        
        echo "ðŸ”§ Building unsigned $FLAVOR_CAP $BUILD_TYPE_CAP APK..."
        echo "   Command: ./gradlew assemble${FLAVOR_CAP}${BUILD_TYPE_CAP}"
        
        # Show build info before building
        if [ "$FLAVOR" = "pro" ]; then
          echo "ðŸ” PRO BUILD: R8 + ProGuard protection will be applied"
        else
          echo "ðŸ“– STANDARD BUILD: Clean build, no protection"
        fi
        
        # Build APK (unsigned)
        ./gradlew assemble${FLAVOR_CAP}${BUILD_TYPE_CAP} --stacktrace
        
        # Show build result
        if [ $? -eq 0 ]; then
          echo "âœ… Build successful!"
          echo "ðŸ“¦ APK files generated:"
          find app/build/outputs/apk -name "*.apk" -type f | while read apk; do
            echo "   ðŸ“± $apk"
            ls -la "$apk"
          done
        else
          echo "âŒ Build failed!"
          exit 1
        fi
        
        
    
    - name: Run tests
      if: steps.config.outputs.build_type != 'release'
      run: |
        FLAVOR="${{ steps.config.outputs.flavor }}"
        BUILD_TYPE="${{ steps.config.outputs.build_type }}"
        
        # Manual capitalization (most compatible)
        if [ "$FLAVOR" = "standard" ]; then
          FLAVOR_CAP="Standard"
        elif [ "$FLAVOR" = "pro" ]; then
          FLAVOR_CAP="Pro"
        fi
        
        if [ "$BUILD_TYPE" = "debug" ]; then
          BUILD_TYPE_CAP="Debug"
        elif [ "$BUILD_TYPE" = "beta" ]; then
          BUILD_TYPE_CAP="Beta"
        elif [ "$BUILD_TYPE" = "release" ]; then
          BUILD_TYPE_CAP="Release"
        fi
        
        echo "ðŸ§ª Running tests for $FLAVOR_CAP $BUILD_TYPE_CAP..."
        ./gradlew test${FLAVOR_CAP}${BUILD_TYPE_CAP}UnitTest --continue
    
    - name: Find and rename APK
      id: apk
      run: |
        BUILD_TYPE="${{ steps.config.outputs.build_type }}"
        FLAVOR="${{ steps.config.outputs.flavor }}"
        
        echo "ðŸ” Looking for APK files..."
        echo "Build Type: $BUILD_TYPE"
        echo "Flavor: $FLAVOR"
        
        # Find APK file with more flexible search
        APK_FILE=""
        
        # Try different possible paths
        POSSIBLE_PATHS=(
          "app/build/outputs/apk/$FLAVOR/$BUILD_TYPE"
          "app/build/outputs/apk/$BUILD_TYPE"
          "app/build/outputs/apk"
        )
        
        for path in "${POSSIBLE_PATHS[@]}"; do
          if [ -d "$path" ]; then
            echo "Checking path: $path"
            APK_FILE=$(find "$path" -name "*.apk" -type f | head -1)
            if [ -n "$APK_FILE" ] && [ -f "$APK_FILE" ]; then
              echo "Found APK: $APK_FILE"
              break
            fi
          fi
        done
        
        if [ -z "$APK_FILE" ] || [ ! -f "$APK_FILE" ]; then
          echo "âŒ No APK file found!"
          echo "Available files in app/build/outputs/apk/:"
          find app/build/outputs/apk/ -name "*.apk" -type f 2>/dev/null || echo "No APK files found"
          exit 1
        fi
        
        # Get version from gradle.properties or default
        VERSION_NAME="2.0.0"
        if [ -f "gradle.properties" ]; then
          VERSION_PROP=$(grep "version.name" gradle.properties | cut -d'=' -f2 2>/dev/null || echo "")
          if [ -n "$VERSION_PROP" ]; then
            VERSION_NAME="$VERSION_PROP"
          fi
        fi
        
        # If version still not found, try from build.gradle
        if [ "$VERSION_NAME" = "2.0.0" ] && [ -f "app/build.gradle" ]; then
          VERSION_GRADLE=$(grep -o 'versionName[[:space:]]*"[^"]*"' app/build.gradle | sed 's/versionName[[:space:]]*"\([^"]*\)"/\1/' | head -1)
          if [ -n "$VERSION_GRADLE" ]; then
            VERSION_NAME="$VERSION_GRADLE"
          fi
        fi
        
        # Create new name
        BUILD_NUMBER="${{ github.run_number }}"
        NEW_NAME="PoolAssistant-${FLAVOR}-${BUILD_TYPE}-v${VERSION_NAME}-build${BUILD_NUMBER}.apk"
        
        # Get directory of original APK
        APK_DIR=$(dirname "$APK_FILE")
        NEW_PATH="$APK_DIR/$NEW_NAME"
        
        # Rename file
        echo "ðŸ“¦ Renaming APK..."
        echo "From: $APK_FILE"
        echo "To: $NEW_PATH"
        
        mv "$APK_FILE" "$NEW_PATH"
        
        if [ -f "$NEW_PATH" ]; then
          echo "âœ… APK renamed successfully: $NEW_NAME"
          
          # Get file size
          APK_SIZE=$(du -h "$NEW_PATH" | cut -f1)
          
          # Set outputs
          echo "apk_path=$NEW_PATH" >> $GITHUB_OUTPUT
          echo "apk_name=$NEW_NAME" >> $GITHUB_OUTPUT
          echo "apk_size=$APK_SIZE" >> $GITHUB_OUTPUT
          
          echo "ðŸ“Š APK Details:"
          echo "  Name: $NEW_NAME"
          echo "  Path: $NEW_PATH"
          echo "  Size: $APK_SIZE"
        else
          echo "âŒ Failed to rename APK"
          exit 1
        fi
    
    - name: Generate build info
      run: |
        FLAVOR="${{ steps.config.outputs.flavor }}"
        BUILD_TYPE="${{ steps.config.outputs.build_type }}"
        if [ "$FLAVOR" = "pro" ]; then
          ROOT_SUPPORT="Yes"
          LIBSU_INTEGRATION="Yes"
        else
          ROOT_SUPPORT="No"
          LIBSU_INTEGRATION="No"
        fi
        if [ "$BUILD_TYPE" = "release" ]; then
          R8_OBFUSCATION="Yes"
        else
          R8_OBFUSCATION="No"
        fi
        VERSION_NAME=$(grep "versionName" app/build.gradle | sed 's/.*"\(.*\)".*/\1/')
        
        echo "Pool Assistant Build Info" > build_info.txt
        echo "" >> build_info.txt
        echo "Build Details:" >> build_info.txt
        echo "â€¢ Flavor: $FLAVOR" >> build_info.txt
        echo "â€¢ Build Type: $BUILD_TYPE" >> build_info.txt
        echo "â€¢ Version: $VERSION_NAME" >> build_info.txt
        echo "â€¢ Build Number: ${{ github.run_number }}" >> build_info.txt
        echo "â€¢ Commit: $(git rev-parse --short HEAD)" >> build_info.txt
        echo "â€¢ Build Time: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> build_info.txt
        echo "" >> build_info.txt
        echo "APK Details:" >> build_info.txt
        echo "â€¢ File: ${{ steps.apk.outputs.apk_name }}" >> build_info.txt
        echo "â€¢ Size: ${{ steps.apk.outputs.apk_size }}" >> build_info.txt
        echo "â€¢ Min SDK: 24 (Android 7.0)" >> build_info.txt
        echo "â€¢ Target SDK: 34 (Android 14)" >> build_info.txt
        echo "" >> build_info.txt
        echo "Features:" >> build_info.txt
        echo "â€¢ Root Support: $ROOT_SUPPORT" >> build_info.txt
        echo "â€¢ libsu Integration: $LIBSU_INTEGRATION" >> build_info.txt
        echo "â€¢ R8 Obfuscation: $R8_OBFUSCATION" >> build_info.txt
    
    - name: Upload APK
      if: steps.apk.outputs.apk_path != ''
      uses: actions/upload-artifact@v4
      with:
        name: ${{ steps.apk.outputs.apk_name }}
        path: ${{ steps.apk.outputs.apk_path }}
        retention-days: 30
    
    - name: Upload build info
      uses: actions/upload-artifact@v4
      with:
        name: build-info-${{ steps.config.outputs.flavor }}-${{ steps.config.outputs.build_type }}
        path: build_info.txt
        retention-days: 7
    
    - name: Create Release
      if: startsWith(github.ref, 'refs/tags/v') && steps.config.outputs.build_type == 'release'
      uses: softprops/action-gh-release@v1
      with:
        files: ${{ steps.apk.outputs.apk_path }}
        body_path: build_info.txt
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    # REMOVED: Cleanup keystore step - not needed for unsigned builds
    # - name: Cleanup keystore
    #   if: always()
    #   ...